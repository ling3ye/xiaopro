---
title: "nRF52840 读取 BME680 环境数据"
boardId: "nrf52840"
moduleId: "sensor/bme680"
date: 2024-01-20
intro: "掌握 nRF52840 的 I2C 通信，读取温度、湿度、气压和空气质量数据。"
---

## 实验简介

BME680 是一款集成了温度、湿度、气压和 VOC 气体传感器的环境监测芯片。本实验将学习如何使用 nRF52840 的 TWI (I2C) 接口读取 BME680 的多传感器数据。

## 硬件连接

| BME680 引脚 | nRF52840 GPIO |
|-------------|---------------|
| VDD         | 3.3V          |
| GND         | GND           |
| SCL         | P0.27         |
| SDA         | P0.26         |

注意：BME680 需要连接上拉电阻（通常已集成在模块上）。

## 代码示例 (Zephyr RTOS)

```c
#include <zephyr/kernel.h>
#include <zephyr/device.h>
#include <zephyr/drivers/i2c.h>
#include <zephyr/sys/printk.h>
#include <zephyr/logging/log.h>

#define BME680_I2C_ADDR    0x76
#define BME680_REG_CHIP_ID 0xD0
#define BME680_CHIP_ID     0x61

LOG_MODULE_REGISTER(bme680, LOG_LEVEL_INF);

static const struct device *i2c_dev = DEVICE_DT_GET(DT_NODELABEL(i2c0));

static int bme680_read_reg(uint8_t reg, uint8_t *value)
{
    return i2c_reg_read_byte(i2c_dev, BME680_I2C_ADDR, reg, value);
}

static int bme680_write_reg(uint8_t reg, uint8_t value)
{
    return i2c_reg_write_byte(i2c_dev, BME680_I2C_ADDR, reg, value);
}

static int bme680_init(void)
{
    uint8_t chip_id;

    if (!device_is_ready(i2c_dev)) {
        LOG_ERR("I2C device not ready");
        return -ENODEV;
    }

    if (bme680_read_reg(BME680_REG_CHIP_ID, &chip_id) != 0) {
        LOG_ERR("Failed to read chip ID");
        return -EIO;
    }

    if (chip_id != BME680_CHIP_ID) {
        LOG_ERR("Invalid chip ID: 0x%02X", chip_id);
        return -EINVAL;
    }

    LOG_INF("BME680 detected (ID: 0x%02X)", chip_id);
    return 0;
}

int main(void)
{
    int ret = bme680_init();
    if (ret != 0) {
        return ret;
    }

    while (1) {
        // 这里添加读取传感器数据的代码
        k_sleep(K_MSEC(1000));
    }

    return 0;
}
```

## 传感器配置

BME680 需要进行初始化配置才能正常工作：

1. **温湿度模式设置**：设置温度和湿度的过采样倍数
2. **气压模式设置**：设置气压的过采样倍数和滤波器参数
3. **气体传感器配置**：设置加热器温度和持续时间
4. **采样模式**：配置强制采样或自动采样模式

## 数据计算

### 温度计算
读取的 ADC 值需要经过补偿算法计算实际温度。

### 湿度计算
使用温度补偿参数和湿度补偿算法计算相对湿度。

### 气压计算
使用气压补偿算法计算大气压力（Pa）。

### 气体阻值计算
根据加热器的温度和持续时间计算气体传感器的阻值。

## 扩展应用

- **智能家居**：室内环境监测，联动空调、加湿器
- **气象站**：户外气象数据采集
- **空气质量监测**：检测 VOC 气体浓度

## 常见问题

**Q：读取到全零数据？**
A：检查 I2C 地址是否正确（可能是 0x76 或 0x77）。

**Q：温度数据异常？**
A：确保使用了正确的补偿算法，不同固件库的实现可能略有差异。

**Q：气体传感器读数不变化？**
A：气体传感器需要预热，首次上电后需要等待约 5 分钟才能稳定。
