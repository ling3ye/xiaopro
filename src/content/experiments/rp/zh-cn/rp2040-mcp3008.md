---
title: "RP2040 读取 MCP3008 模拟信号"
boardId: "rp2040"
moduleId: "sensor/mcp3008"
date: 2024-01-15
intro: "使用 SPI 接口读取 10 位 ADC 模块，掌握 RP2040 的 SPI 通信基础。"
---

## 实验简介

MCP3008 是一款 10 位精度、8 通道的模数转换芯片。本实验将学习如何通过 SPI 接口连接 RP2040 和 MCP3008，并读取模拟电压值。

## 硬件连接

| MCP3008 引脚 | RP2040 GPIO |
|--------------|-------------|
| VDD          | 3.3V        |
| VREF         | 3.3V        |
| AGND         | GND         |
| CLK          | GP2 (SCK)   |
| DOUT         | GP0 (MISO)  |
| DIN          | GP3 (MOSI)  |
| CS/SHDN      | GP1 (CS)    |
| DGND         | GND         |

## 代码示例

```python
import machine
import time
import utime

# SPI 配置
spi = machine.SPI(0, sck=machine.Pin(2), mosi=machine.Pin(3), miso=machine.Pin(0), baudrate=1000000)
cs = machine.Pin(1, machine.Pin.OUT)

def read_adc(channel):
    """读取 MCP3008 指定通道的值"""
    if channel < 0 or channel > 7:
        return -1

    cs.value(0)
    # 发送起始位 + 通道配置
    spi.writebyte([1, (8 + channel) << 4, 0])
    # 读取数据
    result = spi.read(2)
    cs.value(1)

    # 组合 10 位数据
    adc_value = ((result[0] & 0x03) << 8) + result[1]
    return adc_value

def read_voltage(channel):
    """将 ADC 值转换为电压"""
    adc_value = read_adc(channel)
    voltage = (adc_value / 1023) * 3.3
    return voltage

# 主循环
while True:
    ch0_value = read_adc(0)
    ch0_voltage = read_voltage(0)

    print(f"Channel 0: ADC={ch0_value}, Voltage={ch0_voltage:.2f}V")
    time.sleep(0.5)
```

## 实验要点

1. **SPI 时序**：CS 拉低开始通信，拉高结束通信
2. **数据格式**：MCP3008 使用 10 位数据格式，需要从返回字节中提取有效位
3. **电压参考**：VREF 决定了 ADC 的满量程范围

## 扩展应用

- 连接电位器，制作数字电压表
- 连接光敏电阻，实现环境光监测
- 连接 NTC 热敏电阻，实现温度测量

## 常见问题

**Q：读取数值跳动很大？**
A：检查 VREF 是否稳定，可在 VREF 和 GND 之间添加 100nF 电容去耦。

**Q：只能读取到 0 或 1023？**
A：检查 SPI 引脚连接和 CS 信号是否正常工作。
